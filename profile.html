<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Profile — Qlix 2</title>

<style>
body{
  font-family:sans-serif;
  background:#547538;
  margin:0;
}

.card{
  background:rgba(255,255,255,0.2);
  padding:20px;
  margin:20px;
  border-radius:12px;
}
</style>
</head>
<body>

<div class="card">
  <img id="pic" width="80"><br><br>
  <h2 id="name"></h2>
  <div id="followSection" style="margin-top:10px;">
  <button id="followBtn">Follow</button>
  <p id="followStats"></p>
</div>


  <div id="editor" style="display:none;">
    <input id="newName" placeholder="New username"><br><br>
    <input type="file" id="newPic"><br><br>
    <button id="saveBtn">Save Changes</button>
  </div>
</div>

<div id="posts"></div>

<script type="module">
import {
  addDoc, deleteDoc, getDocs, doc,
  collection, query, where
} from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
import { getAuth, onAuthStateChanged, updateProfile } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";
import { getFirestore, collection, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-storage.js";

const app=initializeApp({
 apiKey:"AIzaSyDP0yDxmCrcIXK_DkdXJZB_XzPRVPXMCyo",
 authDomain:"qlix-2701b.firebaseapp.com",
 projectId:"qlix-2701b",
 storageBucket:"qlix-2701b.firebasestorage.app"
});

const auth=getAuth(app);
const db=getFirestore(app);
const storage=getStorage(app);

const params=new URLSearchParams(location.search);
const editMode=params.get("edit")==="true";
const uid=params.get("uid");

const postsQuery=query(collection(db,"posts"),where("authorId","==",uid||""));

onSnapshot(postsQuery,snap=>{
 posts.innerHTML="";

 snap.docs.forEach(d=>{
   const data=d.data();

   name.textContent=data.authorName;
   pic.src=data.authorPic;

   const div=document.createElement("div");
   div.className="card";
   div.innerHTML=data.text;
   posts.appendChild(div);
 });
});

onAuthStateChanged(auth,user=>{
 if(editMode && user){
   editor.style.display="block";

   saveBtn.onclick=async()=>{
     const newName=newNameInput.value || user.displayName;

     let photoURL=user.photoURL;

     if(newPic.files[0]){
       const storageRef=ref(storage,"profilePics/"+user.uid);
       await uploadBytes(storageRef,newPic.files[0]);
       photoURL=await getDownloadURL(storageRef);
     }

     await updateProfile(user,{
       displayName:newName,
       photoURL:photoURL
     });

     alert("Profile updated!");
     location.reload();
   };
 }
});

const followBtn = document.getElementById("followBtn");
const followStats = document.getElementById("followStats");

onAuthStateChanged(auth, async user => {
  if (!uid || !user || uid === user.uid) {
    followBtn.style.display = "none";
    return;
  }

  const followsRef = collection(db, "follows");

  async function updateStats() {
    const followersSnap = await getDocs(query(followsRef, where("following", "==", uid)));
    const followingSnap = await getDocs(query(followsRef, where("follower", "==", uid)));

    followStats.textContent =
      followersSnap.size + " followers • " + followingSnap.size + " following";
  }

  async function checkFollow() {
    const snap = await getDocs(query(
      followsRef,
      where("follower", "==", user.uid),
      where("following", "==", uid)
    ));

    if (snap.empty) {
      followBtn.textContent = "Follow";
      followBtn.dataset.following = "false";
    } else {
      followBtn.textContent = "Unfollow";
      followBtn.dataset.following = "true";
      followBtn.dataset.docId = snap.docs[0].id;
    }
  }

  followBtn.onclick = async () => {
    if (followBtn.dataset.following === "true") {
      await deleteDoc(doc(db, "follows", followBtn.dataset.docId));
    } else {
      await addDoc(followsRef, {
        follower: user.uid,
        following: uid
      });
    }
    await checkFollow();
    await updateStats();
  };

  await checkFollow();
  await updateStats();
});
</script>

</body>
</html>
